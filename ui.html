<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: Inter, sans-serif;
      margin: 0;
      padding: 24px 20px;
      color: #333;
      background-color: #000;
      font-weight: 400; /* Set default font weight to regular */
      overflow: visible; /* Allow content to overflow */
    }

    .container {
      display: flex;
      width: 350px;
      padding: 24px 20px;
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
      background: #000;
      overflow: visible; /* Allow content to overflow */
    }

    .section {
      display: flex;
      flex-direction: column;
      gap: 8px; /* Reduced gap between elements */
      width: 100%;
      position: relative; /* For dropdown positioning */
      overflow: visible; /* Allow content to overflow */
    }

    .view-section {
      display: none; /* Hidden by default */
      flex-direction: column;
      gap: 12px; /* Changed from 4px to 16px */
      padding-top: 16px; /* Changed from 8px to 16px */
    }

    h2 {
      margin: 0 0 16px 0;
      color: #FFF;
      font-size: 16px;
      font-weight: 400;
    }

    select, button {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 16px;
    }

    select {
      display: flex;
      height: 40px;
      padding: 10px;
      justify-content: space-between;
      align-items: center;
      align-self: stretch; 
      border-radius: 8px;
      background: #141416;
      font-size: 14px;
      margin-bottom: 0;
      color: #B0B0B0; /* Default text color for unselected state */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23B0B0B0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px;
      cursor: pointer;
      border: none;
      outline: none;
      box-shadow: none;
      transition: all 0.2s ease;
    }

    select:hover {
      background-color: #1a1a1a;
    }

    select:required:invalid {
      color: #B0B0B0;
    }

    select option[value=""] {
      display: none;
    }

    select option {
      background-color: #1a1a1a;
      color: #E0E0E0;
      padding-right: 30px;
      cursor: pointer;
      border: none;
      outline: none;
      box-shadow: none;
      transition: background-color 0.2s;
    }

    select.selected-value {
      color: #FFFFFF;
      padding-right: 46px; /* Space for x button (14px) + gap (12px) + chevron (20px) */
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23FFFFFF" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
    }

    select.selected-value option {
      color: #B0B0B0;
    }

    select option:checked {
      background-color: #2C2C2C;
      color: #FFFFFF;
    }

    button {
      background: #18A0FB;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      height: 40px; /* Fixed height */
      min-height: 40px; /* Ensure minimum height */
      box-sizing: border-box; /* Include padding in height calculation */
    }

    button:hover {
      background: #0D8DE3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .error {
      color: #dc2626;
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }

    .error.active {
      display: block;
    }

    .success {
      color: #059669;
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }

    .success.active {
      display: block;
    }

    .spinner {
      width: 14px; /* Smaller spinner */
      height: 14px; /* Smaller spinner */
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
      margin: 0; /* Remove any margin */
      flex-shrink: 0; /* Prevent spinner from shrinking */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .view-options {
      display: flex;
      gap: 16px;
      margin-bottom: 16px; /* Changed from 12px to 16px */
      align-items: center;
    }

    .view-option input[type="radio"] {
      margin-right: 4px;
    }

    .view-option label {
      font-size: 14px;
    }

    .view-options-segmented {
      display: flex;
      margin-bottom: 16px; /* Changed from 12px to 16px */
      border: none;
      border-radius: 8px;
      overflow: hidden;
      background-color: #1C1C1F;
      align-items: center;
      padding: 2px 8px;
    }

    .segmented-button {
      flex: none; /* Explicitly prevent flexing */
      width: 172px !important; /* Set a fixed width */
      text-align: center;
      padding: 12px 24px; /* Adjust padding as needed */
      font-size: 16px; /* Adjust font size */
      font-weight: 500; /* Adjust font weight */
      cursor: pointer;
      background-color: transparent; /* Make inactive background transparent again */
      color: #FFF; /* White text for both states */
      transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out; /* Add smoother transition */
      box-sizing: border-box; /* Include padding and border in element's total width */
    }

    .segmented-button:not(.active):hover {
      color: #656565; /* Lighter text color on hover for unselected buttons */
    }

    .segmented-button input[type="radio"] {
      display: none;
    }

    .segmented-button.active {
        background-color: #636366; /* Grey background for the active state */
        height: 28px;
        width: 172px !important; /* Set a fixed width */
        padding: 6px 8px 6.002px 8px; /* Specific padding for active state */
        justify-content: center; /* Keep justify-content for text centering */
        align-items: center; /* Keep align-items for vertical centering */
        flex: none; /* Explicitly prevent flexing */
        border-radius: 7px;
        border: 0.5px solid rgba(0, 0, 0, 0.04);
        box-sizing: border-box; /* Ensure consistent box-sizing */
    }

    .segmented-button:not(:last-child) {
        border-right: none;
    }

    .segmented-button input[type="radio"]:disabled + span,
    .segmented-button input[type="radio"]:disabled + label {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .segmented-button input[type="radio"]:disabled {
        cursor: not-allowed;
    }

    .section-label {
        color: #888; /* Match image label color */
        font-size: 14px;
        margin-bottom: 8px;
        font-weight: 400;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      margin-bottom: 0;
      background: #FFF; /* White background */
      color: #000; /* Black text */
      cursor: pointer;
      font-weight: 500; /* Keep button font weight as 500 */
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: #d0d0d0; /* Slightly darker white on hover */
    }

    button:disabled {
      background: #444; /* Darker background when disabled */
      color: #888; /* Lighter text when disabled */
      cursor: not-allowed;
    }

    .error {
      color: #f87171; /* Lighter red for errors on dark background */
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }

    .error.active {
      display: block;
    }

    .success {
      color: #4ade80; /* Lighter green for success on dark background */
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }

    .success.active {
      display: block;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #000000;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none; /* Hidden by default */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .view-options-segmented {
      display: flex;
      margin-bottom: 12px;
      border: 1px solid #444; /* Darker border for segmented control */
      border-radius: 6px;
      overflow: hidden;
      background-color: #2C2C2C; /* Match dropdown background */
    }

    .segmented-button {
      flex-grow: 1;
      text-align: center;
      padding: 8px 0;
      font-size: 14px;
      cursor: pointer;
      background-color: #2C2C2C; /* Inactive background */
      color: #E0E0E0; /* Inactive text color */
      transition: background-color 0.2s, color 0.2s;
    }

    .segmented-button input[type="radio"] {
      display: none; /* Hide the actual radio button */
    }

    .segmented-button.active {
        background-color: #5A5A5A; /* Softer dark grey background for active state */
        color: #FFF; /* White text for active state */
    }

    .segmented-button:not(:last-child) {
        border-right: 1px solid #444; /* Darker border between segments */
    }

     .segmented-button input[type="radio"]:disabled + span {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .segmented-button input[type="radio"]:disabled + span {
        cursor: not-allowed;
        opacity: 0.6;
    }

     .segmented-button input[type="radio"]:disabled + label {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .segmented-button input[type="radio"]:disabled {
        cursor: not-allowed;
    }

    /* Corrected disabled styling */
    .segmented-button input[type="radio"]:disabled + span {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .view-options-segmented {
      display: flex;
      margin-bottom: 12px;
      border: none; /* Remove border */
      border-radius: 8px; /* Match dropdown border-radius */
      overflow: hidden;
      background-color: #1C1C1F; /* Match dropdown background */
    }

    .segmented-button {
      flex-grow: 1;
      text-align: center;
      padding: 10px 0; /* Match dropdown padding vertically */
      font-size: 14px;
      cursor: pointer;
      background-color: transparent; /* Inactive background transparent to show container background */
      color: #E0E0E0; /* Inactive text color */
      transition: background-color 0.2s, color 0.2s;
    }

    .segmented-button input[type="radio"] {
      display: none; /* Hide the actual radio button */
    }

    .segmented-button.active {
        background-color: #5A5A5A; /* Softer dark grey background for active state */
        color: #FFF; /* White text for active state */
    }

    .segmented-button:not(:last-child) {
        border-right: none; /* Remove border between segments */
    }

     .segmented-button input[type="radio"]:disabled + span {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .segmented-button input[type="radio"]:disabled {
        cursor: not-allowed;
    }

    .section-title{
      color: #636366;
      font-size: 14px;
      font-weight: 400;
      line-height: normal;
    }

    /* Add new styles for tabs */
    .tab-navigation {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      border-bottom: 1px solid #2C2C2C;
      padding-bottom: 0px;
    }

    .tab-button {
      padding: 8px 16px;
      background: transparent !important;
      border: none;
      color: #636366;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      margin: 0;
      width: auto;
    }

    .tab-button:hover {
      color: rgb(150, 150, 161);
      background: transparent !important;
    }

    .tab-button.active {
      color: #FFFFFF;
      border-radius: 0px;
      border-bottom: 1.5px solid #ffffff;
      background: transparent !important;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Add styles for multi-select */
    .multi-select-container {
      position: relative;
      width: 100%;
    }

    .multi-select {
      width: 100%;
      min-height: 40px;
      padding: 10px;
      border-radius: 8px;
      background: #141416;
      color: #B0B0B0;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    .multi-select option {
      padding: 8px;
      background: #141416;
      color: #E0E0E0;
    }

    .multi-select option:checked {
      background: #2C2C2C;
      color: #FFFFFF;
    }

    .multi-select option:hover {
      background: #2C2C2C;
    }

    /* Add styles for dropdown container */
    .dropdown-container {
      position: relative;
      width: 100%;
      overflow: visible;
    }

    /* Style for the dropdown list */
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #141416;
      border-radius: 8px;
      margin-top: 4px;
      max-height: 240px;
      overflow-y: hidden;
      z-index: 1000;
      display: none;
    }

    .dropdown-list.active {
      display: block;
    }

    .dropdown-search {
      padding: 8px;
      border-bottom: 1px solid #2C2C2C;
      position: sticky;
      top: 0;
      background: #141416;
      z-index: 1;
    }

    .dropdown-search input {
      width: 100%;
      padding: 8px;
      border: 1px solid #2C2C2C;
      border-radius: 4px;
      background: #1a1a1a;
      color: #FFFFFF;
      font-size: 14px;
    }

    .dropdown-search input:focus {
      outline: none;
      border-color: #FFFFFF;
    }

    .dropdown-items {
      max-height: calc(240px - 45px); /* Subtract search input height */
      overflow-y: auto;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      min-height: 34px;
      font-size: 14px;
      color: #B0B0B0;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dropdown-item input[type="checkbox"] {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      border: 1px solid #2C2C2C;
      border-radius: 3px;
      background: #1a1a1a;
      position: relative;
      margin: 0; /* Ensure no default margins */
      appearance: none;
      -webkit-appearance: none;
    }

    .dropdown-item input[type="checkbox"]:checked {
      background: #000000;
      border-color: #FFFFFF;
    }

    .dropdown-item input[type="checkbox"]:checked::after {
      content: '';
      position: absolute;
      left: 2px;
      top: 2px;
      width: 12px;
      height: 12px;
      background-image: url('data:image/svg+xml;utf8,<svg width="14" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 3L4.5 8.5L2 6" stroke="%23FDFDFD" stroke-linecap="round" stroke-linejoin="round"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
    }

    .dropdown-item span {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin: 0; /* Ensure no default margins */
      padding: 0; /* Ensure no default padding */
    }

    .dropdown-item:hover {
      background: #1a1a1a;
      color: #FFFFFF;
    }

    .dropdown-item.selected {
      background: #2C2C2C;
      color: #FFFFFF;
    }

    .dropdown-item.hidden-item {
      display: none;
    }

    .info-message {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: #636366;
    }

    .info-message svg {
      width: 20px;
      height: 20px;
    }

    .info-message span {
      line-height: 16px;
    }
  </style>
</head>
<body>
  <div class="tab-navigation">
    <button class="tab-button active" data-tab="default">Default</button>
    <button class="tab-button" data-tab="create-new">Create New</button>
  </div>

  <div id="default-tab" class="tab-content active">
    <h2 class="section-title">Select Module and Tab</h2>
    <div class="section">
      <select id="moduleSelect">
        <option value="Payables">Payables</option>
        <option value="Payments">Payments</option>
        <option value="Accounting">Accounting</option>
        <option value="Smart Statements">Smart Statements</option>
        <option value="Reports">Reports</option>
        <option value="Team Settings">Team Settings</option>
        <option value="Vendors">Vendors</option>
      </select>
      <select id="presetSelect">
        <!-- Will be populated dynamically -->
      </select>

      <div class="view-section">
        <label class="section-title">Select a view</label>
        <div class="view-options-segmented">
          <label for="defaultView" class="segmented-button">
            <input type="radio" id="defaultView" name="viewType" value="default" checked disabled>
            <span>Default columns</span>
          </label>
          <label for="allColumnsView" class="segmented-button">
            <input type="radio" id="allColumnsView" name="viewType" value="all" disabled>
            <span>All columns</span>
          </label>
        </div>
      </div>

      <button id="generate"><span id="generateText">Generate Table</span><span class="spinner"></span></button>
      <div id="error" class="error"></div>
      <div id="success" class="success"></div>
    </div>
  </div>

  <div id="create-new-tab" class="tab-content">
    <div class="section">
      <label class="section-title">Select all columns as needed</label>
      <div class="dropdown-container">
        <select id="columnSelect" class="selected-value" required onmousedown="return false;" onfocus="this.blur();">
          <option value="" disabled selected>Choose columns...</option>
          <option value="Checkbox">Checkbox</option>
          <option value="Bill Narration">Bill Narration</option>
          <option value="Payment Title">Payment Title</option>
          <option value="Vendor">Vendor</option>
          <option value="User Name">User Name</option>
          <option value="Beneficiary">Beneficiary</option>
          <option value="ID">ID</option>
          <option value="UTR">UTR</option>
          <option value="PO Number">PO Number</option>
          <option value="Due Date">Due Date</option>
          <option value="Posting Date">Posting Date</option>
          <option value="Cost Centre">Cost Centre</option>
          <option value="Uploaded By">Uploaded By</option>
          <option value="Created By">Created By</option>
          <option value="Authorised By">Authorised By</option>
          <option value="Created At">Created At</option>
          <option value="Business Unit">Business Unit</option>
          <option value="Payment Mode">Payment Mode</option>
          <option value="Bill Amount">Bill Amount</option>
          <option value="Payment Amount">Payment Amount</option>
          <option value="Bill Date">Bill Date</option>
          <option value="Credited On">Credited On</option>
          <option value="Branches">Branches</option>
          <option value="Status">Status</option>
          <option value="Mysa Category">Mysa Category</option>
          <option value="Department">Department</option>
          <option value="Due Amount">Due Amount</option>
          <option value="Bill">Bill</option>
          <option value="Beneficiary Account">Beneficiary Account</option>
          <option value="Authorised on">Authorised on</option>
          <option value="Pay by date">Pay by date</option>
          <option value="Pan">Pan</option>
          <option value="Gstin">Gstin</option>
          <option value="Category">Category</option>
          <option value="Outstanding">Outstanding</option>
          <option value="This Month's Spend">This Month's Spend</option>
          <option value="Type">Type</option>
          <option value="Role">Role</option>
          <option value="User type">User type</option>
          <option value="COA/Ledger">COA/Ledger</option>
          <option value="Manager(s)">Manager(s)</option>
          <option value="Paid through">Paid through</option>
          <option value="Email">Email</option>
          <option value="Link">Link</option>
          <option value="Date">Date</option>
          <option value="Running balance">Running balance</option>
          <option value="Month">Month</option>
          <option value="Section">Section</option>
          <option value="Description">Description</option>
          <option value="Business type">Business type</option>
          <option value="Amount">Amount</option>
          <option value="> 60 days">> 60 days</option>
          <option value="40 - 60 days">40 - 60 days</option>
          <option value="31 - 45 days">31 - 45 days</option>
          <option value="1 - 30 days">1 - 30 days</option>
          <option value="Total Overdue">Total Overdue</option>
          <option value="Approved By">Approved By</option>
          <option value="Next Approved By">Next Approved By</option>
          <option value="Fin Review By">Fin Review By</option>
          <option value="Reviewed By">Reviewed By</option>
          <option value="RRN/UTR">RRN/UTR</option>
          <option value="Pay On">Pay On</option>
          <option value="Title">Title</option>
          <option value="Payment Method">Payment Method</option>
          <option value="Authorizers">Authorizers</option>
          <option value="Paid At">Paid At</option>
          <option value="Title/Narration">Title/Narration</option>
          <option value="Narration">Narration</option>
          <option value="Rejected By">Rejected By</option>
          <option value="Created On">Created On</option>
          <option value="Status (Accounting)">Status (Accounting)</option>
          <option value="ERP Vendor">ERP Vendor</option>
          <option value="Status (Vendor)">Status (Vendor)</option>
          <option value="Status (Team settings)">Status (Team settings)</option>
          <option value="Custom column 1">Custom column 1</option>
          <option value="Custom column 2">Custom column 2</option>
          <option value="Custom column 3">Custom column 3</option>
        </select>
        <button id="clearColumnSelection" style="
          position: absolute;
          right: 32px; /* Position before the chevron with 12px gap */
          top: 50%;
          transform: translateY(-50%);
          background: none;
          border: none;
          cursor: pointer;
          width: auto;
          padding: 0;
          display: none; /* Hidden by default */
        ">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9.91536 4.08594L4.08203 9.91927M4.08203 4.08594L9.91536 9.91927" stroke="white" stroke-width="1.16667" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="dropdown-list">
          <!-- Options will be populated by JavaScript -->
        </div>
      </div>
      <div class="info-message">
        <span>Search & select a custom column if you need to add a new column that doesn't exist in the component</span>
      </div>
      <button id="generateCustom" style="margin-top: 16px;"><span id="generateCustomText">Create Custom Table</span><span class="spinner"></span></button>
      <div id="customError" class="error"></div>
      <div id="customSuccess" class="success"></div>
    </div>
  </div>

  <script>
    const moduleSelect = document.getElementById('moduleSelect');
    const presetSelect = document.getElementById('presetSelect');
    const generateBtn = document.getElementById('generate');
    const errorDiv = document.getElementById('error');
    const successDiv = document.getElementById('success');
    const defaultViewRadio = document.getElementById('defaultView');
    const allColumnsViewRadio = document.getElementById('allColumnsView');
    const viewOptionsSegmented = document.querySelector('.view-options-segmented');
    const viewSection = document.querySelector('.view-section'); // Get reference to view section
    const spinner = generateBtn.querySelector('.spinner'); // Get reference to the spinner element
    const generateText = document.getElementById('generateText'); // Get reference to the text span

    // Function to update the active class on segmented buttons
    function updateSegmentedButtons() {
        viewOptionsSegmented.querySelectorAll('.segmented-button').forEach(label => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio.checked) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        });
    }

    // Call initially to set the active class for the default checked radio
    updateSegmentedButtons();

    // Check initial value of moduleSelect and add selected-value class if needed
    if (moduleSelect.value) {
        moduleSelect.classList.add('selected-value');
    }

    const moduleTabs = {
      "Payables": ["My Approvals", "Finance Review", "All Drafts", "Drafts", "My Uploads", "All Bills", "Rejected"],
      "Payments": ["Ready to Pay", "In Auth", "All Transactions", "Rejected"],
      "Accounting": ["Needs Review", "Ready to sync", "Synced", "Excluded"],
      "Smart Statements": ["Smart Statements"],
      "Reports": ["AP Overdue", "TDS"],
      "Team Settings": ["Active/Inactive"],
      "Vendors": ["Active/Inactive", "Invited"]
    };

    // Initialize tabs dropdown if Payables is selected by default
    if (moduleSelect.value === "Payables") {
      presetSelect.disabled = false;
      
      // Add placeholder option
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Choose a tab...';
      placeholder.disabled = true;
      placeholder.selected = true;
      presetSelect.appendChild(placeholder);
      
      // Add the actual tab options
      moduleTabs["Payables"].forEach(tab => {
        const option = document.createElement('option');
        option.value = tab;
        option.textContent = tab;
        presetSelect.appendChild(option);
      });
    }

    function setLoading(isLoading) {
      console.log('Setting loading state:', isLoading);
      const spinner = generateBtn.querySelector('.spinner');
      if (!spinner) {
        console.error('Spinner element not found');
        return;
      }
      
      generateBtn.disabled = isLoading;
      errorDiv.classList.remove('active');
      successDiv.classList.remove('active');

      if (isLoading) {
        spinner.style.display = 'inline-block';
        generateText.textContent = 'Creating... '; // Update text through the span
      } else {
        spinner.style.display = 'none';
        generateText.textContent = 'Generate Table '; // Update text through the span
      }
    }

    // Populate tabs dropdown based on module selection
    moduleSelect.addEventListener('change', () => {
      const selectedModule = moduleSelect.value;
      
      // Add/remove selected-value class based on value
      if (selectedModule) {
        moduleSelect.classList.add('selected-value');
      } else {
        moduleSelect.classList.remove('selected-value');
      }
      
      // Clear existing options and disable tabs dropdown initially
      presetSelect.innerHTML = '';
      presetSelect.disabled = true;
      generateBtn.disabled = true;
      errorDiv.classList.remove('active');
      successDiv.classList.remove('active');

      // Disable view options and hide view section
      defaultViewRadio.disabled = true;
      allColumnsViewRadio.disabled = true;
      defaultViewRadio.checked = true; // Reset to default view
      updateSegmentedButtons(); // Update active class
      viewSection.style.display = 'none'; // Hide view section

      if (selectedModule && moduleTabs[selectedModule]) {
        const tabs = moduleTabs[selectedModule];
        
        // Enable the dropdown
        presetSelect.disabled = false;
        
        if (tabs.length === 1) {
          // If only one tab, preselect it
          const option = document.createElement('option');
          option.value = tabs[0];
          option.textContent = tabs[0];
          presetSelect.appendChild(option);
          presetSelect.value = tabs[0];
          presetSelect.classList.add('selected-value'); // Add selected-value class
          
          // Enable generate button and view options
          generateBtn.disabled = false;
          defaultViewRadio.disabled = false;
          allColumnsViewRadio.disabled = false;
          viewSection.style.display = 'flex';
          updateSegmentedButtons();
        } else {
          // If multiple tabs, add placeholder
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Choose a tab...';
          placeholder.disabled = true;
          placeholder.selected = true;
          presetSelect.appendChild(placeholder);
          presetSelect.classList.remove('selected-value'); // Remove selected-value class
          
          // Add the actual tab options
          tabs.forEach(tab => {
            const option = document.createElement('option');
            option.value = tab;
            option.textContent = tab;
            presetSelect.appendChild(option);
          });
        }
      }
    });

    // Enable generate button and view options only when a tab is selected
    presetSelect.addEventListener('change', () => {
      const tabSelected = !!presetSelect.value;

      // Add/remove selected-value class based on value
      if (presetSelect.value) {
        presetSelect.classList.add('selected-value');
      } else {
        presetSelect.classList.remove('selected-value');
      }

      generateBtn.disabled = !tabSelected;
      defaultViewRadio.disabled = !tabSelected;
      allColumnsViewRadio.disabled = !tabSelected;
      errorDiv.classList.remove('active');
      successDiv.classList.remove('active');
      updateSegmentedButtons();

      // Show or hide the view section based on tab selection
      if (tabSelected) {
        viewSection.style.display = 'flex';
      } else {
        viewSection.style.display = 'none';
      }
    });

    generateBtn.addEventListener('click', () => {
      const selectedModule = moduleSelect.value;
      const selectedTab = presetSelect.value;
      const selectedViewType = document.querySelector('input[name="viewType"]:checked').value;

      if (!selectedModule) {
        showError('Please select a module');
        return;
      }

      if (!selectedTab) {
        showError('Please select a tab');
        return;
      }
      
      // Set loading state
      setLoading(true);

      // Set timeout for loading state
      const loadingTimeout = setTimeout(() => {
        console.log('Loading timeout reached for preset table');
        setLoading(false);
        showError('Table generation timed out. Please try again.');
      }, 10000); // 10 second timeout

      parent.postMessage({
        pluginMessage: {
          type: 'generate-preset-table',
          module: selectedModule,
          preset: selectedTab,
          viewType: selectedViewType // Include the selected view type
        }
      }, '*');

      // Add one-time message handler for this generation
      const messageHandler = (event) => {
        const message = event.data.pluginMessage;
        if (!message) return;

        console.log('Received plugin message for preset table:', message);

        if (message.type === 'generation-complete') {
          console.log('Preset generation completed');
          clearTimeout(loadingTimeout);
          showSuccess('Table generated successfully!');
          setLoading(false);
          window.removeEventListener('message', messageHandler);
        } else if (message.type === 'generation-error') {
          console.log('Preset generation failed:', message.error);
          clearTimeout(loadingTimeout);
          showError(message.error);
          setLoading(false);
          window.removeEventListener('message', messageHandler);
        }
      };

      window.addEventListener('message', messageHandler);
    });

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.classList.add('active');
      successDiv.classList.remove('active');
      // No timeout here, user needs to see the error until they change selection or try again
    }

    function showSuccess(message) {
      successDiv.textContent = message;
      successDiv.classList.add('active');
      errorDiv.classList.remove('active');
      setTimeout(() => {
        successDiv.classList.remove('active');
      }, 3000);
    }

    // Add event listeners to the segmented buttons to update active class
    viewOptionsSegmented.addEventListener('change', updateSegmentedButtons);

    // COMBINED window.onmessage handler to avoid overwrites
    window.onmessage = (event) => {
      // Ensure the message is from the parent frame (the plugin)
      // Removed: if (event.source !== parent) { ... }

      const message = event.data.pluginMessage;
      if (!message) {
        console.log('Received message without pluginMessage (ignoring):', event.data);
        return;
      }

      console.log('UI received plugin message:', message.type, message);

      switch (message.type) {
        case 'generation-complete':
          showSuccess('Table generated successfully!');
          setLoading(false);
          break;
        case 'generation-error':
          showError(message.error);
          setLoading(false);
          break;
        case 'update-presets':
          presetSelect.innerHTML = '';
          message.presets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset;
            option.textContent = preset;
            presetSelect.appendChild(option);
          });
          break;
        case 'custom-generation-complete':
          customSuccessDiv.textContent = 'Custom table generated successfully!';
          customSuccessDiv.classList.add('active');
          customErrorDiv.classList.remove('active');
          setCustomLoading(false);
          break;
        case 'custom-generation-error':
          customErrorDiv.textContent = message.error || 'An error occurred while generating the table';
          customErrorDiv.classList.add('active');
          customSuccessDiv.classList.remove('active');
          setCustomLoading(false);
          break;
        // case 'all-columns-data': // This case was previously removed and is no longer needed
        //   allColumns = message.columns;
        //   populateDropdownList(); // Re-populate dropdown with new data if needed (currently done from options)
        //   break;
        default:
          console.log('UI received unknown message type:', message.type);
          break;
      }
    };

    // Add tab switching functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        // Add active class to clicked button and corresponding content
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });

    // Add event listener for custom table generation
    const generateCustomBtn = document.getElementById('generateCustom');
    const columnSelect = document.getElementById('columnSelect');
    const customErrorDiv = document.getElementById('customError');
    const customSuccessDiv = document.getElementById('customSuccess');
    const generateCustomText = document.getElementById('generateCustomText'); // Get reference to the custom text span

    // Function to handle loading state for custom table generation
    function setCustomLoading(isLoading) {
      console.log('Setting custom loading state:', isLoading);
      const spinner = generateCustomBtn.querySelector('.spinner');
      if (!spinner) {
        console.error('Spinner element not found in generateCustomBtn');
        return;
      }
      
      generateCustomBtn.disabled = isLoading;
      customErrorDiv.classList.remove('active');
      customSuccessDiv.classList.remove('active');

      if (isLoading) {
        spinner.style.display = 'inline-block';
        generateCustomText.textContent = 'Creating... ';
      } else {
        spinner.style.display = 'none';
        generateCustomText.textContent = 'Create Custom Table ';
      }
    }

    // Add selected-value class handling for column select
    columnSelect.addEventListener('change', () => {
      if (columnSelect.value) {
        columnSelect.classList.add('selected-value');
      } else {
        columnSelect.classList.remove('selected-value');
      }
    });

    // Add custom dropdown functionality
    const dropdownList = document.querySelector('.dropdown-list');
    const selectedColumns = new Set();
    let allColumns = [];

    // Populate dropdown list
    function populateDropdownList() {
      const dropdownItems = dropdownList.querySelector('.dropdown-items');
      if (!dropdownItems) {
        dropdownList.innerHTML = `
          <div class="dropdown-search">
            <input type="text" placeholder="Search columns..." />
          </div>
          <div class="dropdown-items"></div>
        `;
      }

      const searchInput = dropdownList.querySelector('input');
      const itemsContainer = dropdownList.querySelector('.dropdown-items');
      
      // Clear existing items
      itemsContainer.innerHTML = '';
      
      // Add all options from the select element
      Array.from(columnSelect.options).forEach(option => {
        if (option.value) { // Skip the placeholder option
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = selectedColumns.has(option.value);
          
          const label = document.createElement('span');
          label.textContent = option.textContent;
          
          item.appendChild(checkbox);
          item.appendChild(label);
          item.dataset.value = option.value;
          
          if (selectedColumns.has(option.value)) {
            item.classList.add('selected');
          }
          
          item.addEventListener('click', (e) => {
            if (e.target === checkbox) {
              e.stopPropagation();
            }
            
            if (selectedColumns.has(option.value)) {
              selectedColumns.delete(option.value);
              item.classList.remove('selected');
              checkbox.checked = false;
            } else {
              selectedColumns.add(option.value);
              item.classList.add('selected');
              checkbox.checked = true;
            }
            updateSelectDisplay();
          });
          
          itemsContainer.appendChild(item);
        }
      });

      // Add search functionality
      searchInput.addEventListener('input', (e) => {
        const searchText = e.target.value.toLowerCase();
        const items = dropdownList.querySelectorAll('.dropdown-item');
        items.forEach(item => {
          const text = item.textContent.toLowerCase();
          if (text.includes(searchText)) {
            item.classList.remove('hidden-item');
          } else {
            item.classList.add('hidden-item');
          }
        });
      });
    }

    // Update the select display
    function updateSelectDisplay() {
      const clearColumnSelectionBtn = document.getElementById('clearColumnSelection');
      if (selectedColumns.size === 0) {
        columnSelect.value = '';
        columnSelect.classList.remove('selected-value');
        columnSelect.options[0].textContent = 'Choose columns...';
        columnSelect.style.color = '#B0B0B0';
        clearColumnSelectionBtn.style.display = 'none';
      } else {
        columnSelect.classList.add('selected-value');
        // Update the display text to show selected count
        columnSelect.options[0].textContent = `${selectedColumns.size} columns selected`;
        columnSelect.style.color = '#FFFFFF';
        clearColumnSelectionBtn.style.display = 'block';
      }
    }

    // Toggle dropdown
    columnSelect.addEventListener('click', (e) => {
      e.preventDefault();
      dropdownList.classList.toggle('active');
      if (dropdownList.classList.contains('active')) {
        populateDropdownList();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!columnSelect.contains(e.target) && !dropdownList.contains(e.target)) {
        dropdownList.classList.remove('active');
      }
    });

    // Update generate button click handler
    generateCustomBtn.addEventListener('click', () => {
      console.log('Generate button clicked');
      
      if (selectedColumns.size === 0) {
        customErrorDiv.textContent = 'Please select at least one column';
        customErrorDiv.classList.add('active');
        customSuccessDiv.classList.remove('active');
        return;
      }
      
      // Convert Set to Array to maintain order
      const orderedColumns = Array.from(selectedColumns);
      console.log('Selected columns for generation:', orderedColumns);
      
      // Reset any previous states
      customErrorDiv.classList.remove('active');
      customSuccessDiv.classList.remove('active');
      
      // Set loading state
      setCustomLoading(true);
      
      // Send message to plugin
      try {
        const message = {
          pluginMessage: {
            type: 'generate-custom-table',
            columns: orderedColumns
          }
        };
        console.log('Sending message to plugin:', message);
        parent.postMessage(message, '*');
      } catch (error) {
        console.error('Error sending message to plugin:', error);
        setCustomLoading(false);
        customErrorDiv.textContent = 'Error communicating with plugin. Please try again.';
        customErrorDiv.classList.add('active');
      }
    });

    // Add event listener for clearing column selection
    const clearColumnSelectionBtn = document.getElementById('clearColumnSelection');
    clearColumnSelectionBtn.addEventListener('click', () => {
      selectedColumns.clear();
      columnSelect.value = '';
      columnSelect.classList.remove('selected-value');
      updateSelectDisplay();
    });
  </script>
</body>
</html> 
